<!DOCTYPE html>
<html lang="en">
<head>
    <title>Web Chat</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        * {
            border-color: #fff;
            color: #fff;
            background: #343434;
        }

        fieldset {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            gap: 0.5rem;
        }
    </style>
</head>
<body>

<form onsubmit="login(event)">
    <fieldset>
        <legend>Login</legend>
        <label for="email">Email</label>
        <input value="gabrielbritobellini@gmail.com" type="text" id="email" placeholder="Your email">

        <label for="password">Password</label>
        <input value="Senh@123" type="password" id="password" placeholder="Your password">

        <input type="submit">
    </fieldset>
</form>
<form onsubmit="sendMessage(event)">
    <fieldset>
        <legend>Messager</legend>
        <label for="message">Message</label>
        <input type="text" id="message" placeholder="Type your message">
        <button>Send</button>
    </fieldset>
</form>
<div id="chat">
</div>


<script>
    const apiDomain = "localhost:8080"
    let ws = new WebSocket(`ws://${apiDomain}/api/ws`);

    console.log("ws.OPEN", ws.OPEN)

    ws.onmessage = function (event) {
        const msg = JSON.parse(event.data);
        const chatDiv = document.getElementById("chat");
        const messageDiv = document.createElement("div");
        messageDiv.textContent = msg.name + ": " + msg.text;
        chatDiv.appendChild(messageDiv);
    };

    async function login(event) {
        try {
            console.log(event)
            event.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            let response = await fetch(`http://${apiDomain}/login`, {
                method: "POST",
                body: JSON.stringify({email: email, password: password})
            });

            console.log("response.ok", response.ok)

            email.value = "";
            password.value = "";

            response = await fetch(`http://${apiDomain}/api/me`, {
                method: "GET",
                headers: {
                    "credentials": "same-origin",
                    "Content-Type": "application/json"
                }
            });

            const user = await response.json()
            localStorage.setItem("user", JSON.stringify(user))

        } catch (e) {
            console.log(e);
        }
    }


    function sendMessage(e) {
        e.preventDefault();
        const message = document.getElementById("message").value;
        const userString = localStorage.getItem("user");
        const user = JSON.parse(userString)
        ws.send(JSON.stringify({text: message}));
        message.value = "";
    }
</script>
</body>
</html>